"use strict";

require("core-js/modules/es.array.iterator");

require("core-js/modules/es.promise");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _lodash = _interopRequireDefault(require("lodash"));

var _moment = _interopRequireDefault(require("moment"));

var _baseScraperWithBrowser = require("./base-scraper-with-browser");

var _elementsInteractions = require("../helpers/elements-interactions");

var _navigation = require("../helpers/navigation");

var _fetch = require("../helpers/fetch");

var _transactions = require("../transactions");

var _baseScraper = require("./base-scraper");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const BASE_URL = 'https://start.telebank.co.il';
const DATE_FORMAT = 'YYYYMMDD';

function convertTransactions(txns, txnStatus) {
  if (!txns) {
    return [];
  }

  return txns.map(txn => {
    return {
      type: _transactions.TransactionTypes.Normal,
      identifier: txn.OperationNumber,
      date: (0, _moment.default)(txn.OperationDate, DATE_FORMAT).toISOString(),
      processedDate: (0, _moment.default)(txn.ValueDate, DATE_FORMAT).toISOString(),
      originalAmount: txn.OperationAmount,
      originalCurrency: 'ILS',
      chargedAmount: txn.OperationAmount,
      description: txn.OperationDescriptionToDisplay,
      status: txnStatus
    };
  });
}

async function fetchAccountData(page, options) {
  const apiSiteUrl = `${BASE_URL}/Titan/gatewayAPI`;
  const accountDataUrl = `${apiSiteUrl}/userAccountsData`;
  const accountInfo = await (0, _fetch.fetchGetWithinPage)(page, accountDataUrl);

  if (!accountInfo) {
    return {
      success: false,
      errorType: _baseScraper.ScraperErrorTypes.Generic,
      errorMessage: 'failed to get account data'
    };
  }

  const accountNumber = accountInfo.UserAccountsData.DefaultAccountNumber;
  const defaultStartMoment = (0, _moment.default)().subtract(1, 'years').add(1, 'day');
  const startDate = options.startDate || defaultStartMoment.toDate();

  const startMoment = _moment.default.max(defaultStartMoment, (0, _moment.default)(startDate));

  const startDateStr = startMoment.format(DATE_FORMAT);
  const txnsUrl = `${apiSiteUrl}/lastTransactions/${accountNumber}/Date?IsCategoryDescCode=True&IsTransactionDetails=True&IsEventNames=True&IsFutureTransactionFlag=True&FromDate=${startDateStr}`;
  const txnsResult = await (0, _fetch.fetchGetWithinPage)(page, txnsUrl);

  if (!txnsResult || txnsResult.Error || !txnsResult.CurrentAccountLastTransactions) {
    return {
      success: false,
      errorType: _baseScraper.ScraperErrorTypes.Generic,
      errorMessage: txnsResult && txnsResult.Error ? txnsResult.Error.MsgText : 'unknown error'
    };
  }

  const completedTxns = convertTransactions(txnsResult.CurrentAccountLastTransactions.OperationEntry, _transactions.TransactionStatuses.Completed);

  const rawFutureTxns = _lodash.default.get(txnsResult, 'CurrentAccountLastTransactions.FutureTransactionsBlock.FutureTransactionEntry');

  const pendingTxns = convertTransactions(rawFutureTxns, _transactions.TransactionStatuses.Pending);
  const accountData = {
    success: true,
    accounts: [{
      accountNumber,
      balance: txnsResult.CurrentAccountLastTransactions.CurrentAccountInfo.AccountBalance,
      txns: [...completedTxns, ...pendingTxns]
    }]
  };
  return accountData;
}

async function navigateOrErrorLabel(page) {
  try {
    await (0, _navigation.waitForNavigation)(page);
  } catch (e) {
    await (0, _elementsInteractions.waitUntilElementFound)(page, '#general-error', false, 100);
  }
}

function getPossibleLoginResults() {
  const urls = {};
  urls[_baseScraperWithBrowser.LoginResults.Success] = [`${BASE_URL}/apollo/retail/#/MY_ACCOUNT_HOMEPAGE`];
  urls[_baseScraperWithBrowser.LoginResults.InvalidPassword] = [`${BASE_URL}/apollo/core/templates/lobby/masterPage.html#/LOGIN_PAGE`];
  urls[_baseScraperWithBrowser.LoginResults.ChangePassword] = [`${BASE_URL}/apollo/core/templates/lobby/masterPage.html#/PWD_RENEW`];
  return urls;
}

function createLoginFields(credentials) {
  return [{
    selector: '#tzId',
    value: credentials.id
  }, {
    selector: '#tzPassword',
    value: credentials.password
  }, {
    selector: '#aidnum',
    value: credentials.num
  }];
}

class DiscountScraper extends _baseScraperWithBrowser.BaseScraperWithBrowser {
  getLoginOptions(credentials) {
    return {
      loginUrl: `${BASE_URL}/login/#/LOGIN_PAGE`,
      checkReadiness: async () => (0, _elementsInteractions.waitUntilElementFound)(this.page, '#tzId'),
      fields: createLoginFields(credentials),
      submitButtonSelector: '.sendBtn',
      postAction: async () => navigateOrErrorLabel(this.page),
      possibleResults: getPossibleLoginResults()
    };
  }

  async fetchData() {
    return fetchAccountData(this.page, this.options);
  }

}

var _default = DiscountScraper;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zY3JhcGVycy9kaXNjb3VudC50cyJdLCJuYW1lcyI6WyJCQVNFX1VSTCIsIkRBVEVfRk9STUFUIiwiY29udmVydFRyYW5zYWN0aW9ucyIsInR4bnMiLCJ0eG5TdGF0dXMiLCJtYXAiLCJ0eG4iLCJ0eXBlIiwiVHJhbnNhY3Rpb25UeXBlcyIsIk5vcm1hbCIsImlkZW50aWZpZXIiLCJPcGVyYXRpb25OdW1iZXIiLCJkYXRlIiwiT3BlcmF0aW9uRGF0ZSIsInRvSVNPU3RyaW5nIiwicHJvY2Vzc2VkRGF0ZSIsIlZhbHVlRGF0ZSIsIm9yaWdpbmFsQW1vdW50IiwiT3BlcmF0aW9uQW1vdW50Iiwib3JpZ2luYWxDdXJyZW5jeSIsImNoYXJnZWRBbW91bnQiLCJkZXNjcmlwdGlvbiIsIk9wZXJhdGlvbkRlc2NyaXB0aW9uVG9EaXNwbGF5Iiwic3RhdHVzIiwiZmV0Y2hBY2NvdW50RGF0YSIsInBhZ2UiLCJvcHRpb25zIiwiYXBpU2l0ZVVybCIsImFjY291bnREYXRhVXJsIiwiYWNjb3VudEluZm8iLCJzdWNjZXNzIiwiZXJyb3JUeXBlIiwiU2NyYXBlckVycm9yVHlwZXMiLCJHZW5lcmljIiwiZXJyb3JNZXNzYWdlIiwiYWNjb3VudE51bWJlciIsIlVzZXJBY2NvdW50c0RhdGEiLCJEZWZhdWx0QWNjb3VudE51bWJlciIsImRlZmF1bHRTdGFydE1vbWVudCIsInN1YnRyYWN0IiwiYWRkIiwic3RhcnREYXRlIiwidG9EYXRlIiwic3RhcnRNb21lbnQiLCJtb21lbnQiLCJtYXgiLCJzdGFydERhdGVTdHIiLCJmb3JtYXQiLCJ0eG5zVXJsIiwidHhuc1Jlc3VsdCIsIkVycm9yIiwiQ3VycmVudEFjY291bnRMYXN0VHJhbnNhY3Rpb25zIiwiTXNnVGV4dCIsImNvbXBsZXRlZFR4bnMiLCJPcGVyYXRpb25FbnRyeSIsIlRyYW5zYWN0aW9uU3RhdHVzZXMiLCJDb21wbGV0ZWQiLCJyYXdGdXR1cmVUeG5zIiwiXyIsImdldCIsInBlbmRpbmdUeG5zIiwiUGVuZGluZyIsImFjY291bnREYXRhIiwiYWNjb3VudHMiLCJiYWxhbmNlIiwiQ3VycmVudEFjY291bnRJbmZvIiwiQWNjb3VudEJhbGFuY2UiLCJuYXZpZ2F0ZU9yRXJyb3JMYWJlbCIsImUiLCJnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cyIsInVybHMiLCJMb2dpblJlc3VsdHMiLCJTdWNjZXNzIiwiSW52YWxpZFBhc3N3b3JkIiwiQ2hhbmdlUGFzc3dvcmQiLCJjcmVhdGVMb2dpbkZpZWxkcyIsImNyZWRlbnRpYWxzIiwic2VsZWN0b3IiLCJ2YWx1ZSIsImlkIiwicGFzc3dvcmQiLCJudW0iLCJEaXNjb3VudFNjcmFwZXIiLCJCYXNlU2NyYXBlcldpdGhCcm93c2VyIiwiZ2V0TG9naW5PcHRpb25zIiwibG9naW5VcmwiLCJjaGVja1JlYWRpbmVzcyIsImZpZWxkcyIsInN1Ym1pdEJ1dHRvblNlbGVjdG9yIiwicG9zdEFjdGlvbiIsInBvc3NpYmxlUmVzdWx0cyIsImZldGNoRGF0YSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFFQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQTs7OztBQUtBLE1BQU1BLFFBQVEsR0FBRyw4QkFBakI7QUFDQSxNQUFNQyxXQUFXLEdBQUcsVUFBcEI7O0FBNEJBLFNBQVNDLG1CQUFULENBQTZCQyxJQUE3QixFQUF5REMsU0FBekQsRUFBd0c7QUFDdEcsTUFBSSxDQUFDRCxJQUFMLEVBQVc7QUFDVCxXQUFPLEVBQVA7QUFDRDs7QUFDRCxTQUFPQSxJQUFJLENBQUNFLEdBQUwsQ0FBVUMsR0FBRCxJQUFTO0FBQ3ZCLFdBQU87QUFDTEMsTUFBQUEsSUFBSSxFQUFFQywrQkFBaUJDLE1BRGxCO0FBRUxDLE1BQUFBLFVBQVUsRUFBRUosR0FBRyxDQUFDSyxlQUZYO0FBR0xDLE1BQUFBLElBQUksRUFBRSxxQkFBT04sR0FBRyxDQUFDTyxhQUFYLEVBQTBCWixXQUExQixFQUF1Q2EsV0FBdkMsRUFIRDtBQUlMQyxNQUFBQSxhQUFhLEVBQUUscUJB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TFMsTUFBQUEsUUFBUSxFQUFHLEdBQUVyRixRQUFTLHFCQURqQjtBQUVMc0YsTUFBQUEsY0FBYyxFQUFFLFlBQVksaURBQXNCLEtBQUs3RCxJQUEzQixFQUFpQyxPQUFqQyxDQUZ2QjtBQUdMOEQsTUFBQUEsTUFBTSxFQUFFWixpQkFBaUIsQ0FBQ0MsV0FBRCxDQUhwQjtBQUlMWSxNQUFBQSxvQkFBb0IsRUFBRSxVQUpqQjtBQUtMQyxNQUFBQSxVQUFVLEVBQUUsWUFBWXRCLG9CQUFvQixDQUFDLEtBQUsxQyxJQUFOLENBTHZDO0FBTUxpRSxNQUFBQSxlQUFlLEVBQUVyQix1QkFBdUI7QUFObkMsS0FBUDtBQVFEOztBQUVELFFBQU1zQixTQUFOLEdBQWtCO0FBQ2hCLFdBQU9uRSxnQkFBZ0IsQ0FBQyxLQUFLQyxJQUFOLEVBQVksS0FBS0MsT0FBakIsQ0FBdkI7QUFDRDs7QUFka0Q7O2VBaUJ0Q3dELGUiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnO1xuaW1wb3J0IHsgUGFnZSB9IGZyb20gJ3B1cHBldGVlcic7XG5pbXBvcnQgeyBCYXNlU2NyYXBlcldpdGhCcm93c2VyLCBMb2dpblJlc3VsdHMsIFBvc3NpYmxlTG9naW5SZXN1bHRzIH0gZnJvbSAnLi9iYXNlLXNjcmFwZXItd2l0aC1icm93c2VyJztcbmltcG9ydCB7IHdhaXRVbnRpbEVsZW1lbnRGb3VuZCB9IGZyb20gJy4uL2hlbHBlcnMvZWxlbWVudHMtaW50ZXJhY3Rpb25zJztcbmltcG9ydCB7IHdhaXRGb3JOYXZpZ2F0aW9uIH0gZnJvbSAnLi4vaGVscGVycy9uYXZpZ2F0aW9uJztcbmltcG9ydCB7IGZldGNoR2V0V2l0aGluUGFnZSB9IGZyb20gJy4uL2hlbHBlcnMvZmV0Y2gnO1xuaW1wb3J0IHtcbiAgVHJhbnNhY3Rpb24sIFRyYW5zYWN0aW9uU3RhdHVzZXMsIFRyYW5zYWN0aW9uVHlwZXMsXG59IGZyb20gJy4uL3RyYW5zYWN0aW9ucyc7XG5pbXBvcnQge1xuICBTY3JhcGVyT3B0aW9ucyxcbiAgU2NyYXBlckVycm9yVHlwZXMsIFNjYXBlclNjcmFwaW5nUmVzdWx0LCBTY3JhcGVyQ3JlZGVudGlhbHMsXG59IGZyb20gJy4vYmFzZS1zY3JhcGVyJztcblxuY29uc3QgQkFTRV9VUkwgPSAnaHR0cHM6Ly9zdGFydC50ZWxlYmFuay5jby5pbCc7XG5jb25zdCBEQVRFX0ZPUk1BVCA9ICdZWVlZTU1ERCc7XG5cbmludGVyZmFjZSBTY3JhcGVkVHJhbnNhY3Rpb24ge1xuICBPcGVyYXRpb25OdW1iZXI6IG51bWJlcjtcbiAgT3BlcmF0aW9uRGF0ZTogc3RyaW5nO1xuICBWYWx1ZURhdGU6IHN0cmluZztcbiAgT3BlcmF0aW9uQW1vdW50OiBudW1iZXI7XG4gIE9wZXJhdGlvbkRlc2NyaXB0aW9uVG9EaXNwbGF5OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBDdXJyZW50QWNjb3VudEluZm8ge1xuICBBY2NvdW50QmFsYW5jZTogbnVtYmVyO1xufVxuXG5pbnRlcmZhY2UgU2NyYXBlZEFjY291bnREYXRhIHtcbiAgVXNlckFjY291bnRzRGF0YToge1xuICAgIERlZmF1bHRBY2NvdW50TnVtYmVyOiBzdHJpbmc7XG4gIH07XG59XG5cbmludGVyZmFjZSBTY3JhcGVkVHJhbnNhY3Rpb25EYXRhIHtcbiAgRXJyb3I/OiB7IE1zZ1RleHQ6IHN0cmluZyB9O1xuICBDdXJyZW50QWNjb3VudExhc3RUcmFuc2FjdGlvbnM/OiB7XG4gICAgT3BlcmF0aW9uRW50cnk6IFNjcmFwZWRUcmFuc2FjdGlvbltdO1xuICAgIEN1cnJlbnRBY2NvdW50SW5mbzogQ3VycmVudEFjY291bnRJbmZvO1xuICB9O1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0VHJhbnNhY3Rpb25zKHR4bnM6IFNjcmFwZWRUcmFuc2FjdGlvbltdLCB0eG5TdGF0dXM6IFRyYW5zYWN0aW9uU3RhdHVzZXMpOiBUcmFuc2FjdGlvbltdIHtcbiAgaWYgKCF0eG5zKSB7XG4gICAgcmV0dXJuIFtdO1xuICB9XG4gIHJldHVybiB0eG5zLm1hcCgodHhuKSA9PiB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHR5cGU6IFRyYW5zYWN0aW9uVHlwZXMuTm9ybWFsLFxuICAgICAgaWRlbnRpZmllcjogdHhuLk9wZXJhdGlvbk51bWJlcixcbiAgICAgIGRhdGU6IG1vbWVudCh0eG4uT3BlcmF0aW9uRGF0ZSwgREFURV9GT1JNQVQpLnRvSVNPU3RyaW5nKCksXG4gICAgICBwcm9jZXNzZWREYXRlOiBtb21lbnQodHhuLlZhbHVlRGF0ZSwgREFURV9GT1JNQVQpLnRvSVNPU3RyaW5nKCksXG4gICAgICBvcmlnaW5hbEFtb3VudDogdHhuLk9wZXJhdGlvbkFtb3VudCxcbiAgICAgIG9yaWdpbmFsQ3VycmVuY3k6ICdJTFMnLFxuICAgICAgY2hhcmdlZEFtb3VudDogdHhuLk9wZXJhdGlvbkFtb3VudCxcbiAgICAgIGRlc2NyaXB0aW9uOiB0eG4uT3BlcmF0aW9uRGVzY3JpcHRpb25Ub0Rpc3BsYXksXG4gICAgICBzdGF0dXM6IHR4blN0YXR1cyxcbiAgICB9O1xuICB9KTtcbn1cblxuXG5hc3luYyBmdW5jdGlvbiBmZXRjaEFjY291bnREYXRhKHBhZ2U6IFBhZ2UsIG9wdGlvbnM6IFNjcmFwZXJPcHRpb25zKTogUHJvbWlzZTxTY2FwZXJTY3JhcGluZ1Jlc3VsdD4ge1xuICBjb25zdCBhcGlTaXRlVXJsID0gYCR7QkFTRV9VUkx9L1RpdGFuL2dhdGV3YXlBUElgO1xuXG4gIGNvbnN0IGFjY291bnREYXRhVXJsID0gYCR7YXBpU2l0ZVVybH0vdXNlckFjY291bnRzRGF0YWA7XG4gIGNvbnN0IGFjY291bnRJbmZvID0gYXdhaXQgZmV0Y2hHZXRXaXRoaW5QYWdlPFNjcmFwZWRBY2NvdW50RGF0YT4ocGFnZSwgYWNjb3VudERhdGFVcmwpO1xuXG4gIGlmICghYWNjb3VudEluZm8pIHtcbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBlcnJvclR5cGU6IFNjcmFwZXJFcnJvclR5cGVzLkdlbmVyaWMsXG4gICAgICBlcnJvck1lc3NhZ2U6ICdmYWlsZWQgdG8gZ2V0IGFjY291bnQgZGF0YScsXG4gICAgfTtcbiAgfVxuICBjb25zdCBhY2NvdW50TnVtYmVyID0gYWNjb3VudEluZm8uVXNlckFjY291bnRzRGF0YS5EZWZhdWx0QWNjb3VudE51bWJlcjtcblxuICBjb25zdCBkZWZhdWx0U3RhcnRNb21lbnQgPSBtb21lbnQoKS5zdWJ0cmFjdCgxLCAneWVhcnMnKS5hZGQoMSwgJ2RheScpO1xuICBjb25zdCBzdGFydERhdGUgPSBvcHRpb25zLnN0YXJ0RGF0ZSB8fCBkZWZhdWx0U3RhcnRNb21lbnQudG9EYXRlKCk7XG4gIGNvbnN0IHN0YXJ0TW9tZW50ID0gbW9tZW50Lm1heChkZWZhdWx0U3RhcnRNb21lbnQsIG1vbWVudChzdGFydERhdGUpKTtcblxuICBjb25zdCBzdGFydERhdGVTdHIgPSBzdGFydE1vbWVudC5mb3JtYXQoREFURV9GT1JNQVQpO1xuICBjb25zdCB0eG5zVXJsID0gYCR7YXBpU2l0ZVVybH0vbGFzdFRyYW5zYWN0aW9ucy8ke2FjY291bnROdW1iZXJ9L0RhdGU/SXNDYXRlZ29yeURlc2NDb2RlPVRydWUmSXNUcmFuc2FjdGlvbkRldGFpbHM9VHJ1ZSZJc0V2ZW50TmFtZXM9VHJ1ZSZJc0Z1dHVyZVRyYW5zYWN0aW9uRmxhZz1UcnVlJkZyb21EYXRlPSR7c3RhcnREYXRlU3RyfWA7XG4gIGNvbnN0IHR4bnNSZXN1bHQgPSBhd2FpdCBmZXRjaEdldFdpdGhpblBhZ2U8U2NyYXBlZFRyYW5zYWN0aW9uRGF0YT4ocGFnZSwgdHhuc1VybCk7XG4gIGlmICghdHhuc1Jlc3VsdCB8fCB0eG5zUmVzdWx0LkVycm9yIHx8XG4gICAgIXR4bnNSZXN1bHQuQ3VycmVudEFjY291bnRMYXN0VHJhbnNhY3Rpb25zKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZXJyb3JUeXBlOiBTY3JhcGVyRXJyb3JUeXBlcy5HZW5lcmljLFxuICAgICAgZXJyb3JNZXNzYWdlOiB0eG5zUmVzdWx0ICYmIHR4bnNSZXN1bHQuRXJyb3IgPyB0eG5zUmVzdWx0LkVycm9yLk1zZ1RleHQgOiAndW5rbm93biBlcnJvcicsXG4gICAgfTtcbiAgfVxuXG4gIGNvbnN0IGNvbXBsZXRlZFR4bnMgPSBjb252ZXJ0VHJhbnNhY3Rpb25zKFxuICAgIHR4bnNSZXN1bHQuQ3VycmVudEFjY291bnRMYXN0VHJhbnNhY3Rpb25zLk9wZXJhdGlvbkVudHJ5LFxuICAgIFRyYW5zYWN0aW9uU3RhdHVzZXMuQ29tcGxldGVkLFxuICApO1xuICBjb25zdCByYXdGdXR1cmVUeG5zID0gXy5nZXQodHhuc1Jlc3VsdCwgJ0N1cnJlbnRBY2NvdW50TGFzdFRyYW5zYWN0aW9ucy5GdXR1cmVUcmFuc2FjdGlvbnNCbG9jay5GdXR1cmVUcmFuc2FjdGlvbkVudHJ5Jyk7XG4gIGNvbnN0IHBlbmRpbmdUeG5zID0gY29udmVydFRyYW5zYWN0aW9ucyhyYXdGdXR1cmVUeG5zLCBUcmFuc2FjdGlvblN0YXR1c2VzLlBlbmRpbmcpO1xuXG4gIGNvbnN0IGFjY291bnREYXRhID0ge1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgYWNjb3VudHM6IFt7XG4gICAgICBhY2NvdW50TnVtYmVyLFxuICAgICAgYmFsYW5jZTogdHhuc1Jlc3VsdC5DdXJyZW50QWNjb3VudExhc3RUcmFuc2FjdGlvbnMuQ3VycmVudEFjY291bnRJbmZvLkFjY291bnRCYWxhbmNlLFxuICAgICAgdHhuczogWy4uLmNvbXBsZXRlZFR4bnMsIC4uLnBlbmRpbmdUeG5zXSxcbiAgICB9XSxcbiAgfTtcblxuICByZXR1cm4gYWNjb3VudERhdGE7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG5hdmlnYXRlT3JFcnJvckxhYmVsKHBhZ2U6IFBhZ2UpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCB3YWl0Rm9yTmF2aWdhdGlvbihwYWdlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGF3YWl0IHdhaXRVbnRpbEVsZW1lbnRGb3VuZChwYWdlLCAnI2dlbmVyYWwtZXJyb3InLCBmYWxzZSwgMTAwKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBnZXRQb3NzaWJsZUxvZ2luUmVzdWx0cygpOiBQb3NzaWJsZUxvZ2luUmVzdWx0cyB7XG4gIGNvbnN0IHVybHM6IFBvc3NpYmxlTG9naW5SZXN1bHRzID0ge307XG4gIHVybHNbTG9naW5SZXN1bHRzLlN1Y2Nlc3NdID0gW2Ake0JBU0VfVVJMfS9hcG9sbG8vcmV0YWlsLyMvTVlfQUNDT1VOVF9IT01FUEFHRWBdO1xuICB1cmxzW0xvZ2luUmVzdWx0cy5JbnZhbGlkUGFzc3dvcmRdID0gW2Ake0JBU0VfVVJMfS9hcG9sbG8vY29yZS90ZW1wbGF0ZXMvbG9iYnkvbWFzdGVyUGFnZS5odG1sIy9MT0dJTl9QQUdFYF07XG4gIHVybHNbTG9naW5SZXN1bHRzLkNoYW5nZVBhc3N3b3JkXSA9IFtgJHtCQVNFX1VSTH0vYXBvbGxvL2NvcmUvdGVtcGxhdGVzL2xvYmJ5L21hc3RlclBhZ2UuaHRtbCMvUFdEX1JFTkVXYF07XG4gIHJldHVybiB1cmxzO1xufVxuXG5mdW5jdGlvbiBjcmVhdGVMb2dpbkZpZWxkcyhjcmVkZW50aWFsczogU2NyYXBlckNyZWRlbnRpYWxzKSB7XG4gIHJldHVybiBbXG4gICAgeyBzZWxlY3RvcjogJyN0eklkJywgdmFsdWU6IGNyZWRlbnRpYWxzLmlkIH0sXG4gICAgeyBzZWxlY3RvcjogJyN0elBhc3N3b3JkJywgdmFsdWU6IGNyZWRlbnRpYWxzLnBhc3N3b3JkIH0sXG4gICAgeyBzZWxlY3RvcjogJyNhaWRudW0nLCB2YWx1ZTogY3JlZGVudGlhbHMubnVtIH0sXG4gIF07XG59XG5cbmNsYXNzIERpc2NvdW50U2NyYXBlciBleHRlbmRzIEJhc2VTY3JhcGVyV2l0aEJyb3dzZXIge1xuICBnZXRMb2dpbk9wdGlvbnMoY3JlZGVudGlhbHM6IFNjcmFwZXJDcmVkZW50aWFscykge1xuICAgIHJldHVybiB7XG4gICAgICBsb2dpblVybDogYCR7QkFTRV9VUkx9L2xvZ2luLyMvTE9HSU5fUEFHRWAsXG4gICAgICBjaGVja1JlYWRpbmVzczogYXN5bmMgKCkgPT4gd2FpdFVudGlsRWxlbWVudEZvdW5kKHRoaXMucGFnZSwgJyN0eklkJyksXG4gICAgICBmaWVsZHM6IGNyZWF0ZUxvZ2luRmllbGRzKGNyZWRlbnRpYWxzKSxcbiAgICAgIHN1Ym1pdEJ1dHRvblNlbGVjdG9yOiAnLnNlbmRCdG4nLFxuICAgICAgcG9zdEFjdGlvbjogYXN5bmMgKCkgPT4gbmF2aWdhdGVPckVycm9yTGFiZWwodGhpcy5wYWdlKSxcbiAgICAgIHBvc3NpYmxlUmVzdWx0czogZ2V0UG9zc2libGVMb2dpblJlc3VsdHMoKSxcbiAgICB9O1xuICB9XG5cbiAgYXN5bmMgZmV0Y2hEYXRhKCkge1xuICAgIHJldHVybiBmZXRjaEFjY291bnREYXRhKHRoaXMucGFnZSwgdGhpcy5vcHRpb25zKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBEaXNjb3VudFNjcmFwZXI7XG4iXX0=